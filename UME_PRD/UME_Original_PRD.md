# 统一影像学4D编码器 (UME) 产品需求文档

## 1. 项目概述

### 1.1 项目名称
统一影像学4D编码器 (Unified Medical imaging Efficient 4D-Encoder, UME)

### 1.2 项目目标
设计并实现一个统一的医学影像4D编码器，能够处理多种维度的医学影像数据（2D、3D、4D多模态），通过ViT2D架构和模态融合机制实现高效的特征提取和表示学习。

### 1.3 核心价值
- **统一性**：单一模型处理多种维度输入
- **高效性**：通过关键帧选择和模态融合优化计算复杂度
- **可扩展性**：支持不同医学影像模态的融合
- **准确性**：通过分割任务验证特征表示质量

## 2. 功能需求

### 2.1 输入支持
| 输入类型 | 维度格式 | 标准化后格式 | 描述 |
|---------|---------|-------------|-----|
| 4D多模态 | C×H×W×D | C×H×W×K | 多通道多层医学影像 |
| 3D单模态 | H×W×D | 1×H×W×D | 单通道多层医学影像 |
| 2D单模态 | H×W | 1×H×W×1 | 单通道单层医学影像 |

### 2.2 核心功能模块

#### 2.2.1 维度标准化模块
- **功能**：将不同维度输入标准化为统一的4D格式
- **输入处理规则**：
  - 3D图像：H×W×D → 1×H×W×D
  - 2D图像：H×W → 1×H×W×1
  - 4D图像：C×H×W×D → 保持原格式

#### 2.2.2 关键帧选择模块
- **功能**：从4D图像的D维度选择关键帧
- **选择策略**：
  - 通过注意力网络计算1×D权重张量
  - Top-K选择：K = min(D, 10) if D < 10 else 10
  - 考虑C通道间的相关性
- **输出**：C×H×W×K压缩4D图像
- **约束**：选出的K个通道间语义相似度最小化

#### 2.2.3 ViT2D编码模块
- **功能**：将4D图像转换为Token嵌入
- **处理流程**：
  - C×H×W×K → CK×H×W（通道展开）
  - 通过ViT2D得到CK×P×Emb嵌入
  - P为patch数量，默认64（256×256以32×32划分）
- **优化**：模态内共享K、Q以降低计算复杂度

#### 2.2.4 模态融合模块
- **功能**：多模态特征融合
- **融合机制**：注意力融合
- **输出特征**：
  - 全局融合特征：P×D×K
  - 各模态压缩特征：C×(P//α)×Emb×K

#### 2.2.5 特征输出模块
- **最终输出维度**：PKD(1+C//α)×Emb
- **用途**：可用于下游任务（分割、分类、检测等）

#### 2.2.6 分割验证模块
- **功能**：作为损失约束验证特征质量
- **架构**：轻量级分割网络
- **输入**：C×(P//α)×Emb×K特征
- **输出**：分割掩码

## 3. 技术规范

### 3.1 架构设计

#### 3.1.1 网络架构
```
输入层 → 维度标准化 → 关键帧选择 → ViT2D编码 → 模态融合 → 特征输出
                                                ↓
                                           分割验证网络
```

#### 3.1.2 关键参数
- **Patch大小**：32×32（默认）
- **Patch数量**：P=64（256×256图像）
- **嵌入维度**：Emb（待定，建议512或768）
- **压缩因子**：α（待定，建议4或8）
- **关键帧数量**：K = min(D, 10)

### 3.2 损失函数设计

#### 3.2.1 关键帧选择损失
- **目标**：最小化选出帧间的语义相似度
- **公式**：L_diversity = Σ(similarity(frame_i, frame_j)) for i≠j

#### 3.2.2 分割损失
- **主要损失**：Dice Loss + Cross Entropy Loss
- **用途**：验证特征表示质量

#### 3.2.3 总损失
- **组合**：L_total = λ1 × L_diversity + λ2 × L_segmentation
- **权重**：λ1, λ2待调优

### 3.3 数据处理流程

#### 3.3.1 数据集支持
- **主要数据集**：BraTS数据集
- **数据路径**：`./data/`
- **数据格式**：NIfTI格式医学影像

#### 3.3.2 预处理管道
1. 数据加载
2. 强度归一化
3. 空间重采样
4. 维度标准化
5. 数据增强

## 4. 实现计划

### 4.1 环境设置
- **新环境名称**：UME
- **主要依赖**：
  - PyTorch
  - MONAI
  - timm（用于ViT）
  - numpy
  - nibabel

### 4.2 代码结构

#### 4.2.1 目录结构
```
UME/
├── models/
│   ├── __init__.py
│   ├── ume_encoder.py          # 主编码器
│   ├── keyframe_selector.py    # 关键帧选择
│   ├── modal_fusion.py         # 模态融合
│   └── segmentation_head.py    # 分割头
├── dataloader/
│   ├── __init__.py
│   ├── ume_dataset.py         # UME数据集
│   └── transforms.py          # 数据变换
├── losses/
│   ├── __init__.py
│   ├── diversity_loss.py      # 多样性损失
│   └── combined_loss.py       # 组合损失
├── utils/
│   ├── __init__.py
│   └── metrics.py             # 评估指标
└── train.py                   # 训练脚本
```

#### 4.2.2 核心模块设计

##### UME编码器主类
- 继承自nn.Module
- 整合所有子模块
- 实现前向传播

##### 关键帧选择器
- 注意力机制实现
- Top-K选择算法
- 多样性约束

##### 模态融合器
- 多头注意力机制
- 跨模态交互
- 特征压缩

### 4.3 数据加载器重构

#### 4.3.1 新数据加载器要求
- **兼容性**：支持2D、3D、4D输入
- **灵活性**：可配置的预处理管道
- **效率**：支持缓存和分布式训练
- **扩展性**：易于添加新数据集

#### 4.3.2 与现有代码的关系
- **复用**：保留现有MONAI transforms
- **扩展**：添加新的4D数据处理逻辑
- **独立**：新环境UME独立于现有VoCo环境

## 5. 验证策略

### 5.1 功能验证
- **单元测试**：各模块独立测试
- **集成测试**：端到端pipeline测试
- **数据验证**：不同维度输入处理正确性

### 5.2 性能验证
- **分割精度**：在BraTS数据集上的分割性能
- **计算效率**：推理速度和内存占用
- **收敛性**：训练稳定性和收敛速度

### 5.3 对比实验
- **基线对比**：与传统3D CNN对比
- **消融实验**：各模块贡献度分析
- **参数敏感性**：关键超参数影响

## 6. 风险与挑战

### 6.1 技术风险
- **内存消耗**：4D数据处理的内存需求
- **计算复杂度**：多模态融合的计算开销
- **收敛困难**：多损失函数权衡

### 6.2 缓解策略
- **梯度检查点**：减少内存占用
- **混合精度训练**：提高计算效率
- **渐进式训练**：分阶段训练策略

## 7. 成功指标

### 7.1 技术指标
- **分割精度**：Dice系数 > 0.85
- **推理速度**：单个样本 < 1秒
- **内存效率**：单GPU支持batch_size ≥ 2

### 7.2 代码质量
- **模块化**：清晰的模块划分
- **可维护性**：良好的代码文档
- **可扩展性**：易于添加新功能

## 8. 时间规划

### 8.1 开发阶段
1. **Week 1-2**：环境搭建和数据加载器开发
2. **Week 3-4**：核心模块实现
3. **Week 5-6**：模型集成和初步测试
4. **Week 7-8**：性能优化和验证

### 8.2 里程碑
- **M1**：UME环境搭建完成
- **M2**：基础模型pipeline运行
- **M3**：BraTS数据集训练成功
- **M4**：性能达到预期指标