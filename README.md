# UME: Unified Medical imaging Efficient 4D-Encoder

## é¡¹ç›®ç®€ä»‹

**UME (Unified Medical imaging Efficient 4D-Encoder)** æ˜¯ä¸€ä¸ªå®Œæ•´çš„åŒ»å­¦å½±åƒAIç³»ç»Ÿï¼Œä¸“ä¸ºBraTSè„‘è‚¿ç˜¤åˆ†å‰²ä»»åŠ¡è®¾è®¡ã€‚è¯¥é¡¹ç›®å®ç°äº†è‡ªé€‚åº”å¤šæ¨¡æ€åŠ¨æ€é‡‡æ ·ç¼–ç å™¨å’Œ4DåŒ»å­¦å½±åƒæ•°æ®çš„åˆ†å±‚èåˆã€‚

**æ ¸å¿ƒåˆ›æ–°**: è‡ªé€‚åº”å¤šæ¨¡æ€åŠ¨æ€é‡‡æ ·ç¼–ç å™¨ï¼Œèƒ½å¤Ÿæ™ºèƒ½åœ°é€‰æ‹©å…³é”®å¸§å¹¶æ‰§è¡Œåˆ†å±‚æ¨¡æ€èåˆï¼Œæ”¯æŒä»»æ„æ•°é‡æ¨¡æ€çš„é«˜æ•ˆå¤„ç†ã€‚

### æ ¸å¿ƒç‰¹æ€§

- **åŠ¨æ€é‡‡æ ·**: è‡ªé€‚åº”å…³é”®å¸§é€‰æ‹©ï¼Œæ™ºèƒ½é€‰æ‹©æœ€ç›¸å…³çš„å¸§
- **å¤šæ¨¡æ€èåˆ**: åˆ†å±‚èåˆä»»æ„æ•°é‡æ¨¡æ€ï¼Œæ”¯æŒIntra/Inter/Globalä¸‰çº§èåˆ
- **Transformeræ¶æ„**: åŸºäºVision Transformer (ViT) éª¨å¹²ç½‘ç»œï¼Œä¸“ä¸ºåŒ»å­¦å½±åƒä¼˜åŒ–
- **æ™ºèƒ½å…³é”®å¸§é€‰æ‹©**: å¤šç­–ç•¥åŠ¨æ€é‡‡æ · (å‡åŒ€ + å†…å®¹æ„ŸçŸ¥ + æ³¨æ„åŠ›å¼•å¯¼)
- **é…ç½®é©±åŠ¨**: æ”¯æŒå¤šç§è®­ç»ƒæ¨¡å¼å’Œæ¨¡å‹å¤§å°çš„JSONé…ç½®
- **å®Œæ•´æ•°æ®æµ**: ä¸€æ¬¡è¯»å…¥å®Œæ•´(4, 256, 256, 128)æ•°æ®ï¼Œäº¤ç»™ç½‘ç»œæ™ºèƒ½å¤„ç†
- **åŒæ¨ç†æ¨¡å¼**: æ”¯æŒå…³é”®å¸§æ¨ç†å’Œé€å¸§æ¨ç†
- **ç›‘ç£å­¦ä¹ **: ä¼ ç»Ÿç›‘ç£è®­ç»ƒï¼Œä½¿ç”¨åˆ†å‰²æ ‡ç­¾

## é¡¹ç›®ç»“æ„

```
Unified-Radiology-Efficient-4D-Encoder/
â”œâ”€â”€ ume/                          # æ ¸å¿ƒä»£ç 
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ core/                     # æ ¸å¿ƒæ¨¡å—
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ keyframe_selector.py  # æ™ºèƒ½å…³é”®å¸§é€‰æ‹© (246 lines)
â”‚   â”‚   â””â”€â”€ modal_fusion.py       # å¤šå±‚æ¬¡æ¨¡æ€èåˆ (333 lines)
â”‚   â”œâ”€â”€ models/                   # æ¨¡å‹å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ ume_model.py          # UMEä¸»æ¨¡å‹ (118Må‚æ•°, 451MB)
â”‚   â”œâ”€â”€ data/                     # æ•°æ®åŠ è½½
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ brats_loader.py       # BraTSæ•°æ®åŠ è½½å™¨
â”‚   â”œâ”€â”€ training/                 # è®­ç»ƒè„šæœ¬
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ train_ume.py          # ä¸»è®­ç»ƒè„šæœ¬ (436 lines)
â”‚   â””â”€â”€ utils/                    # å·¥å…·å‡½æ•°
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ losses.py             # æŸå¤±å‡½æ•°
â”‚       â”œâ”€â”€ metrics.py            # è¯„ä¼°æŒ‡æ ‡
â”œâ”€â”€ configs/                      # é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ brats_ume_config.json     # ä¼ ç»Ÿåˆ†å‰²è®­ç»ƒé…ç½®
â”‚   â”œâ”€â”€ brats_ume_main.json       # ä¸»è¦è®­ç»ƒé…ç½®
â”‚   â”œâ”€â”€ brats_ume_fast.json       # å¿«é€Ÿæµ‹è¯•é…ç½®
â”‚   â””â”€â”€ brats_ume_test.json       # æµ‹è¯•é…ç½®
â”œâ”€â”€ jsons/                        # æ•°æ®é›†é…ç½®
â”‚   â””â”€â”€ brats21_folds.json        # è‡ªåŠ¨ç”Ÿæˆçš„æ•°æ®é…ç½®
â”œâ”€â”€ checkpoints/                  # æ¨¡å‹æ£€æŸ¥ç‚¹
â”œâ”€â”€ logs/                         # è®­ç»ƒæ—¥å¿—
â”œâ”€â”€ paper/                        # è®ºæ–‡ç›¸å…³èµ„æ–™
â”œâ”€â”€ modification_requirements/     # ä¿®æ”¹éœ€æ±‚æ–‡æ¡£
â”œâ”€â”€ UME_PRD/                      # äº§å“éœ€æ±‚æ–‡æ¡£
â”œâ”€â”€ quick_start.sh                # å¿«é€Ÿå¯åŠ¨è„šæœ¬
â”œâ”€â”€ start_training.sh             # è®­ç»ƒå¯åŠ¨è„šæœ¬
â”œâ”€â”€ test_medclip.py              # MedCLIPæµ‹è¯•è„šæœ¬
â”œâ”€â”€ requirements.txt              # ä¾èµ–åˆ—è¡¨
â”œâ”€â”€ CLAUDE.md                     # é¡¹ç›®æŒ‡ä»¤æ–‡æ¡£
â”œâ”€â”€ PROJECT_INFO.md               # é¡¹ç›®ä¿¡æ¯
â”œâ”€â”€ PROJECT_COMPLETION_REPORT.md  # é¡¹ç›®å®ŒæˆæŠ¥å‘Š
â”œâ”€â”€ CODE_STATISTICS.md            # ä»£ç ç»Ÿè®¡
â”œâ”€â”€ MED_CLIP_USAGE.md             # MedCLIPä½¿ç”¨è¯´æ˜
â””â”€â”€ README.md                     # æœ¬æ–‡æ¡£
```

## ç¯å¢ƒé…ç½®ä¸å®‰è£…

### ç³»ç»Ÿè¦æ±‚

- **Python**: 3.9+
- **CUDA**: 12.1+ (GPUè®­ç»ƒå¿…éœ€)
- **å†…å­˜**: å»ºè®®16GBä»¥ä¸Šç³»ç»Ÿå†…å­˜
- **GPUå†…å­˜**: å»ºè®®8GBä»¥ä¸Š (å¯é€šè¿‡é…ç½®è°ƒæ•´)

### æ ¸å¿ƒä¾èµ–

- **PyTorch â‰¥2.0.0**: æ·±åº¦å­¦ä¹ æ¡†æ¶
- **MONAI â‰¥1.3.0**: åŒ»å­¦å½±åƒAIå·¥å…·åŒ…ï¼Œæä¾›å˜æ¢ã€æ•°æ®é›†å’ŒæŒ‡æ ‡
- **timm**: é¢„è®­ç»ƒè§†è§‰æ¨¡å‹å’ŒTransformerå®ç°
- **transformers**: Hugging Face Transformeræ¶æ„
- **nibabel**: åŒ»å­¦å½±åƒæ ¼å¼å¤„ç† (.nii.gzæ–‡ä»¶)
- **tensorboard**: è®­ç»ƒå¯è§†åŒ–å’Œæ—¥å¿—è®°å½•

### å¿«é€Ÿå®‰è£…

#### æ­¥éª¤1: åˆ›å»ºç¯å¢ƒ
```bash
# åˆ›å»ºå¹¶æ¿€æ´»condaç¯å¢ƒ
conda create -n ume python=3.9
conda activate ume
```

#### æ­¥éª¤2: å®‰è£…ä¾èµ–
```bash
# å®‰è£…PyTorch (GPUç‰ˆæœ¬)
conda install pytorch torchvision torchaudio pytorch-cuda=12.1 -c pytorch -c nvidia

# å®‰è£…æ‰€æœ‰ä¾èµ–
pip install -r requirements.txt
```

#### æ­¥éª¤3: éªŒè¯å®‰è£…
```bash
# è¿è¡Œç»¼åˆç¯å¢ƒæ£€æŸ¥å’Œäº¤äº’å¼è®­ç»ƒå¯åŠ¨
./quick_start.sh
```

**å¿«é€Ÿå¯åŠ¨è„šæœ¬åŠŸèƒ½**:
- âœ… Pythonç¯å¢ƒæ£€æŸ¥
- âœ… PyTorchå’ŒCUDAå¯ç”¨æ€§éªŒè¯
- âœ… MONAIå®‰è£…ç¡®è®¤
- âœ… é¡¹ç›®ç»“æ„å®Œæ•´æ€§æ£€æŸ¥
- âœ… é…ç½®æ–‡ä»¶å­˜åœ¨æ€§éªŒè¯
- ğŸš€ äº¤äº’å¼è®­ç»ƒæ¨¡å¼é€‰æ‹©

### å¼€å‘ç¯å¢ƒéªŒè¯

```bash
# å¿«é€Ÿç¯å¢ƒéªŒè¯å‘½ä»¤
python -c "import torch; print(f'CUDAå¯ç”¨: {torch.cuda.is_available()}')"
python -c "import monai; print(f'MONAIç‰ˆæœ¬: {monai.__version__}')"

# æµ‹è¯•æ ¸å¿ƒç»„ä»¶
python test_medclip.py
```

## æ•°æ®å‡†å¤‡

### BraTSæ•°æ®é›†ç»“æ„

ç¡®ä¿BraTSæ•°æ®é›†æŒ‰ä»¥ä¸‹ç»“æ„ç»„ç»‡ï¼š

```
/path/to/brats21/
â”œâ”€â”€ BraTS21_Training_001/
â”‚   â”œâ”€â”€ BraTS21_Training_001_t1.nii.gz
â”‚   â”œâ”€â”€ BraTS21_Training_001_t2.nii.gz
â”‚   â”œâ”€â”€ BraTS21_Training_001_t1ce.nii.gz
â”‚   â”œâ”€â”€ BraTS21_Training_001_flair.nii.gz
â”‚   â””â”€â”€ BraTS21_Training_001_seg.nii.gz  # å¯é€‰
â”œâ”€â”€ BraTS21_Training_002/
â”‚   â””â”€â”€ ...
```

### é…ç½®æ•°æ®è·¯å¾„

ä¿®æ”¹é…ç½®æ–‡ä»¶ä¸­çš„æ•°æ®è·¯å¾„ã€‚ä»¥ä¸»é…ç½®ä¸ºä¾‹ï¼š

```json
// configs/brats_ume_main.json
{
  "data": {
    "data_dir": "/path/to/your/brats21",
    "target_size": [256, 256, 128],  // å§‹ç»ˆå®Œæ•´128å¸§
    ...
  }
}
```

**æ³¨æ„**: æ‰€æœ‰é…ç½®æ–‡ä»¶éƒ½éœ€è¦æ›´æ–° `data_dir` å­—æ®µä¸ºæ‚¨çš„BraTSæ•°æ®é›†è·¯å¾„ã€‚

## å¼€å‘å·¥ä½œæµç¨‹

### å¿«é€Ÿå¯åŠ¨

```bash
# æ¿€æ´»ç¯å¢ƒ
conda activate ume

# æ–¹æ³•1: äº¤äº’å¼ç¯å¢ƒéªŒè¯å’Œè®­ç»ƒå¯åŠ¨ (æ¨è)
./quick_start.sh

# æ–¹æ³•2: è‡ªåŠ¨åŒ–è®­ç»ƒå¯åŠ¨è„šæœ¬
./start_training.sh
```

### å¼€å‘å‘½ä»¤

```bash
# å¿«é€Ÿç¯å¢ƒéªŒè¯å’Œäº¤äº’å¼è®­ç»ƒ
./quick_start.sh

# è‡ªåŠ¨åŒ–è®­ç»ƒå¯åŠ¨ (åŒ…å«ç¯å¢ƒæ£€æŸ¥)
./start_training.sh

# æµ‹è¯•Med-CLIPé›†æˆå’Œå…³é”®å¸§é€‰æ‹©å™¨
python test_medclip.py

# å¼€å‘è¿­ä»£ (ä½¿ç”¨å¿«é€Ÿé…ç½®)
python ume/training/train_ume.py --config configs/brats_ume_fast.json
```

### ä¸»è¦è®­ç»ƒå‘½ä»¤

```bash
# ä¸»è¦ç›‘ç£è®­ç»ƒ (ä¸»è¦/æ¨èè®­ç»ƒæ–¹å¼)
python ume/training/train_ume.py --config configs/brats_ume_main.json

# ä¼ ç»Ÿç›‘ç£è®­ç»ƒ (æ›¿ä»£é…ç½®)
python ume/training/train_ume.py --config configs/brats_ume_config.json

# å¿«é€Ÿæµ‹è¯•é…ç½® (å°æ¨¡å‹)
python ume/training/train_ume.py --config configs/brats_ume_fast.json

# åˆ†å¸ƒå¼è®­ç»ƒ
python ume/training/train_ume.py --config configs/brats_ume_main.json --distributed

# ä»æ£€æŸ¥ç‚¹æ¢å¤è®­ç»ƒ
python ume/training/train_ume.py --config configs/brats_ume_main.json --resume /path/to/checkpoint.pth
```

### æµ‹è¯•åŸºç¡€è®¾æ–½

```bash
# æµ‹è¯•Med-CLIPé›†æˆå’Œå…³é”®å¸§é€‰æ‹©å™¨åŠŸèƒ½
python test_medclip.py

# å¿«é€Ÿç¯å¢ƒéªŒè¯ (åœ¨quick_start.shä¸­è‡ªåŠ¨åŒ–)
python -c "import torch; print(f'CUDAå¯ç”¨: {torch.cuda.is_available()}')"
python -c "import monai; print(f'MONAIç‰ˆæœ¬: {monai.__version__}')"
```

### å¼€å‘æµ‹è¯•ç­–ç•¥

- **é›†æˆæµ‹è¯•**: `test_medclip.py` éªŒè¯æ ¸å¿ƒç»„ä»¶
- **å¿«é€Ÿè¿­ä»£**: ä½¿ç”¨ `brats_ume_fast.json` è¿›è¡Œå¿«é€ŸéªŒè¯å¾ªç¯
- **ç¯å¢ƒéªŒè¯**: `quick_start.sh` æä¾›å…¨é¢çš„ç¯å¢ƒæ£€æŸ¥
- **æ— æ­£å¼å•å…ƒæµ‹è¯•**: é¡¹ç›®ä¾èµ–é›†æˆæµ‹è¯•å’Œè®­ç»ƒéªŒè¯

### é…ç½®è¯´æ˜

#### æ¨¡å‹é…ç½®

```json
{
  "model": {
    "input_channels": 4,        // BraTSå››ä¸ªæ¨¡æ€
    "embed_dim": 768,           // åµŒå…¥ç»´åº¦
    "num_heads": 12,            // æ³¨æ„åŠ›å¤´æ•°
    "num_layers": 12,           // Transformerå±‚æ•°
    "patch_size": 32,           // å›¾åƒå—å¤§å°
    "image_size": [256, 256],   // è¾“å…¥å›¾åƒå°ºå¯¸
    "num_classes": 4,           // åˆ†å‰²ç±»åˆ«æ•°
    "max_keyframes": 10,        // æœ€å¤§å…³é”®å¸§æ•°
    "compression_ratio": 4      // ç‰¹å¾å‹ç¼©æ¯”ä¾‹
  }
}
```

#### æ•°æ®é…ç½®

```json
{
  "data": {
    "data_dir": "/path/to/brats21",     // æ•°æ®ç›®å½•
    "target_size": [256, 256, 128],     // ç›®æ ‡å°ºå¯¸ï¼ˆå®Œæ•´128å¸§ï¼‰
    "batch_size": 2,                    // æ‰¹æ¬¡å¤§å°ï¼ˆå»ºè®®è¾ƒå°ï¼‰
    "num_workers": 4,                   // æ•°æ®åŠ è½½è¿›ç¨‹æ•°
    "cache_rate": 0.5,                  // ç¼“å­˜æ¯”ä¾‹
    "use_cache": true                   // æ˜¯å¦ä½¿ç”¨ç¼“å­˜
  }
}
```


#### è®­ç»ƒé…ç½®

```json
{
  "training": {
    "epochs": 100,                      // è®­ç»ƒè½®æ•°
    "learning_rate": 1e-4,              // å­¦ä¹ ç‡
    "weight_decay": 1e-5,               // æƒé‡è¡°å‡
    "warmup_epochs": 10,                // é¢„çƒ­è½®æ•°
    "loss_weights": {
      "diversity": 0.1,                 // å¤šæ ·æ€§æŸå¤±æƒé‡
      "segmentation": 1.0,              // åˆ†å‰²æŸå¤±æƒé‡
      "consistency": 0.05,              // ä¸€è‡´æ€§æŸå¤±æƒé‡
      "temporal": 0.03                  // æ—¶åºæŸå¤±æƒé‡
    }
  }
}
```

## æ ¸å¿ƒæŠ€æœ¯

### 1. æ™ºèƒ½å…³é”®å¸§é€‰æ‹©

- **å‡åŒ€é‡‡æ ·**: åœ¨æ—¶é—´ç»´åº¦ä¸Šå‡åŒ€åˆ†å¸ƒ
- **å†…å®¹æ„ŸçŸ¥**: åŸºäºå¸§é—´å·®å¼‚é€‰æ‹©å…³é”®å¸§
- **æ³¨æ„åŠ›å¼•å¯¼**: ä½¿ç”¨æ³¨æ„åŠ›æœºåˆ¶è¯†åˆ«é‡è¦å¸§
- **ç­–ç•¥èåˆ**: è‡ªé€‚åº”æƒé‡èåˆå¤šç§ç­–ç•¥

### 2. å¤šå±‚æ¬¡æ¨¡æ€èåˆ

- **Intra-Modal**: åŒæ¨¡æ€å†…ä¸åŒåˆ‡ç‰‡èåˆ
- **Inter-Modal**: è·¨æ¨¡æ€ä¿¡æ¯äº¤äº’
- **Global**: å…¨å±€ç‰¹å¾å¢å¼º

### 3. å¤šæ¨¡æ€åŠ¨æ€é‡‡æ ·

è‡ªé€‚åº”å¤šæ¨¡æ€åŠ¨æ€é‡‡æ ·æ˜¯æœ¬é¡¹ç›®çš„æ ¸å¿ƒåˆ›æ–°ï¼š

- **å®Œæ•´æ•°æ®è¯»å–**: ä¸€æ¬¡è¯»å…¥å®Œæ•´(4, 256, 256, 128)æ•°æ®ï¼Œäº¤ç»™ç½‘ç»œæ™ºèƒ½å¤„ç†
- **å…³é”®å¸§é€‰æ‹©**: ç½‘ç»œåŠ¨æ€é€‰æ‹©Kâ‰¤10ä¸ªå…³é”®å¸§è¿›è¡Œç‰¹å¾æå–
- **Patchç»„ç»‡**: 256Ã—256 â†’ 64ä¸ª32Ã—32 patches â†’ (4, 64, 32, 32, K)
- **å¤šæ¨¡æ€èåˆ**: åˆ†å±‚èåˆæ”¯æŒä»»æ„æ•°é‡çš„æ¨¡æ€
- **ç›‘ç£è®­ç»ƒ**: ä½¿ç”¨åˆ†å‰²æ ‡ç­¾è¿›è¡Œæ ‡å‡†ç›‘ç£å­¦ä¹ 
- **è‡ªé€‚åº”é‡‡æ ·**: æ™ºèƒ½é€‰æ‹©æœ€ç›¸å…³çš„å¸§è¿›è¡Œå¤„ç†

### 4. è®­ç»ƒç­–ç•¥

- **ç›‘ç£è®­ç»ƒ**: ä¸»è¦è®­ç»ƒæ–¹å¼ï¼ŒåŸºäºåˆ†å‰²æ ‡ç­¾
- **å…³é”®å¸§ç½‘ç»œ**: æ™ºèƒ½é€‰æ‹©å…³é”®å¸§è¿›è¡Œç‰¹å¾æå–
- **å¤šæ ·æ€§çº¦æŸ**: ç¡®ä¿é€‰æ‹©çš„å¸§å…·æœ‰å¤šæ ·æ€§

## æ€§èƒ½ç›‘æ§

ç›‘ç£è®­ç»ƒè¿‡ç¨‹ä¸­ä¼šæ˜¾ç¤ºä»¥ä¸‹æŒ‡æ ‡ï¼š

```
Training Epoch 0: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 250/250 [02:05<00:00, 1.99it/s, loss=1.8245, seg=1.2150, div=0.1895, cons=0.0567]
```

- **loss**: æ€»æŸå¤±
- **seg**: åˆ†å‰²æŸå¤± (segmentation loss)
- **div**: å…³é”®å¸§å¤šæ ·æ€§æŸå¤± (diversity loss)
- **cons**: ä¸€è‡´æ€§æŸå¤± (consistency loss)

ä¼ ç»Ÿåˆ†å‰²è®­ç»ƒï¼ˆå¯¹æ¯”æ¨¡å¼ï¼‰æ˜¾ç¤ºæŒ‡æ ‡ï¼š

```
Training Epoch 0: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 250/250 [02:05<00:00, 1.99it/s, loss=2.2136, div=0.7695, seg=2.1366]
```

- **seg**: åˆ†å‰²æŸå¤± (segmentation loss)

## è°ƒè¯•å’Œæ€§èƒ½ä¼˜åŒ–

### å†…å­˜ç®¡ç†

- **æ ‡å‡†é…ç½®**: éœ€è¦çº¦8GB GPUå†…å­˜
- **å†…å­˜é—®é¢˜**: å°† `batch_size` ä»2å‡å°‘åˆ°1ï¼Œä½¿ç”¨ `brats_ume_fast.json` é…ç½®
- **ç¼“å­˜ç®¡ç†**: å¦‚æœå†…å­˜å—é™ï¼Œåœ¨é…ç½®ä¸­è®¾ç½® `"use_cache": false`
- **åˆ†å¸ƒå¼è®­ç»ƒ**: å¤šGPUè®¾ç½®ä½¿ç”¨ `--distributed` æ ‡å¿—

### å¸¸è§å¼€å‘é—®é¢˜è§£å†³æ–¹æ¡ˆ

```bash
# é¦–æ¬¡è¿è¡Œæ•°æ®åŠ è½½è¿‡æ…¢
# è§£å†³æ–¹æ¡ˆ: CacheDatasetä¼šé¢„å¤„ç†æ•°æ®ï¼Œåç»­è¿è¡Œä¼šæ›´å¿«

# CUDAå†…å­˜ä¸è¶³
# è§£å†³æ–¹æ¡ˆ: å‡å°‘é…ç½®ä¸­çš„batch_sizeï¼Œä½¿ç”¨å¿«é€Ÿé…ç½®ï¼Œæˆ–ç¦ç”¨ç¼“å­˜

# ç»´åº¦ä¸åŒ¹é…é”™è¯¯
# è§£å†³æ–¹æ¡ˆ: ç¡®ä¿cropå°ºå¯¸åŒ¹é…ViT patchç»´åº¦ (32Ã—32)

# ç¼ºå°‘BraTSæ•°æ®
# è§£å†³æ–¹æ¡ˆ: æ›´æ–°é…ç½®æ–‡ä»¶ä¸­çš„data_dirï¼Œç¡®ä¿.nii.gzæ–‡ä»¶å­˜åœ¨
```

### æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

- **å¿«é€Ÿå¼€å‘**: ä½¿ç”¨ `configs/brats_ume_fast.json` (384 embed_dim, 6å±‚)
- **ç”Ÿäº§ç¯å¢ƒ**: ä½¿ç”¨ `configs/brats_ume_main.json` (768 embed_dim, 12å±‚)
- **ç¼“å­˜ä¼˜åŒ–**: åˆå§‹æ•°æ®å¤„ç†åå¯ç”¨ä»¥åŠ å¿«è®­ç»ƒ
- **æ‰¹æ¬¡å¤§å°**: ä»2å¼€å§‹ï¼Œå¦‚æœ‰å†…å­˜é—®é¢˜åˆ™å‡å°‘åˆ°1

### å†…å­˜ä¸è¶³ä¼˜åŒ–è®¾ç½®

1. **å‡å°‘æ‰¹æ¬¡å¤§å°**:
```json
"batch_size": 1  // ä»2å‡å°‘åˆ°1
```

2. **ä½¿ç”¨å¿«é€Ÿé…ç½®æ¨¡å‹**:
```json
"embed_dim": 384,    // ä»768å‡å°‘åˆ°384
"num_heads": 6,      // ä»12å‡å°‘åˆ°6
"num_layers": 6      // ä»12å‡å°‘åˆ°6
```

3. **ç¦ç”¨ç¼“å­˜**:
```json
"use_cache": false,
"cache_rate": 0.0
```

4. **å‡å°‘å…³é”®å¸§æ•°**:
```json
"max_keyframes": 6,     // ä»10å‡å°‘åˆ°6
"training_frames": 6    // ä»8å‡å°‘åˆ°6
```

## å¸¸è§é—®é¢˜

### Q: æ•°æ®åŠ è½½å¾ˆæ…¢æ€ä¹ˆåŠï¼Ÿ
A: è¿™æ˜¯æ­£å¸¸ç°è±¡ã€‚é¦–æ¬¡è¿è¡Œæ—¶CacheDatasetä¼šé¢„å¤„ç†æ‰€æœ‰æ•°æ®åˆ°å†…å­˜ï¼Œåç»­è®­ç»ƒä¼šå¾ˆå¿«ã€‚å¯ä»¥ï¼š
- ä½¿ç”¨ `"use_cache": false` è¿›è¡Œå³æ—¶åŠ è½½
- å¢åŠ  `num_workers` æ•°é‡
- ä½¿ç”¨SSDå­˜å‚¨åŠ é€ŸI/O

### Q: GPUå†…å­˜ä¸è¶³æ€ä¹ˆåŠï¼Ÿ
A: å‚è€ƒ"å†…å­˜ä¼˜åŒ–"éƒ¨åˆ†ï¼Œé€æ­¥å‡å°‘æ¨¡å‹å¤§å°å’Œæ‰¹æ¬¡å¤§å°ã€‚

### Q: å¦‚ä½•ä¿®æ”¹æ•°æ®è·¯å¾„ï¼Ÿ
A: ä¿®æ”¹é…ç½®æ–‡ä»¶ä¸­çš„ `data_dir` å­—æ®µä¸ºæ‚¨çš„BraTSæ•°æ®é›†è·¯å¾„ã€‚

### Q: å¦‚ä½•ç›‘æ§è®­ç»ƒè¿›åº¦ï¼Ÿ
A: è®­ç»ƒè¿‡ç¨‹ä¼šæ˜¾ç¤ºå®æ—¶æŸå¤±ï¼ŒåŒæ—¶ä¼šä¿å­˜æ£€æŸ¥ç‚¹åˆ°å·¥ä½œç›®å½•ã€‚

## é¡¹ç›®æ–‡æ¡£

é¡¹ç›®åŒ…å«è¯¦ç»†çš„æŠ€æœ¯æ–‡æ¡£å’ŒæŠ¥å‘Šï¼š

- **CLAUDE.md**: Claude Codeä½¿ç”¨æŒ‡å—å’Œé¡¹ç›®è¯¦ç»†è¯´æ˜
- **PROJECT_INFO.md**: é¡¹ç›®æ¦‚è¿°å’Œå…³é”®ä¿¡æ¯
- **PROJECT_COMPLETION_REPORT.md**: é¡¹ç›®å®ŒæˆæŠ¥å‘Šå’ŒæŠ€æœ¯æ€»ç»“
- **CODE_STATISTICS.md**: ä»£ç ç»Ÿè®¡å’Œæ¶æ„åˆ†æ
- **MED_CLIP_USAGE.md**: MedCLIPé›†æˆä½¿ç”¨è¯´æ˜
- **UME_PRD/**: è¯¦ç»†çš„äº§å“éœ€æ±‚æ–‡æ¡£å’ŒæŠ€æœ¯è®¾è®¡

## æ¶æ„æŠ€æœ¯æ ˆ

### æŠ€æœ¯æ”¯æŒ

- **æ¨¡å‹æ¶æ„**: Vision Transformer (ViT) + Multi-Level Modal Fusion
- **æ•°æ®å¤„ç†**: MONAIåŒ»å­¦å½±åƒæ¡†æ¶ + CacheDatasetå†…å­˜ä¼˜åŒ–
- **è®­ç»ƒä¼˜åŒ–**: Mixed Precision + Gradient Scaling
- **å†…å­˜ç®¡ç†**: æ™ºèƒ½å…³é”®å¸§é€‰æ‹© + åŠ¨æ€é‡‡æ ·ç­–ç•¥
- **ç›‘ç£å­¦ä¹ **: ä¼ ç»Ÿåˆ†å‰²ç›‘ç£è®­ç»ƒ
- **é…ç½®ç®¡ç†**: JSONé©±åŠ¨çš„å¤šæ¨¡å¼è®­ç»ƒé…ç½®

### æ¶æ„æ¨¡å¼

- **æ¨¡å—åŒ–è®¾è®¡**: æ•°æ®(`ume/data/`)ã€æ¨¡å‹(`ume/models/`)ã€è®­ç»ƒ(`ume/training/`)å’Œå·¥å…·(`ume/utils/`)æ¸…æ™°åˆ†ç¦»
- **ç›‘ç£å­¦ä¹ **: åˆ†å‰²æ ‡ç­¾ä½œä¸ºä¸»è¦è®­ç»ƒèŒƒå¼
- **å¤šæ¨¡æ€èåˆ**: 4ä¸ªBraTSæ¨¡æ€çš„åˆ†å±‚èåˆï¼Œæ”¯æŒIntra/Inter/Globalä¸‰çº§èåˆ
- **Transformeré©±åŠ¨**: åŸºäºViTéª¨å¹²ç½‘ç»œï¼Œä¸“ä¸ºåŒ»å­¦å½±åƒä¼˜åŒ–
- **é…ç½®é©±åŠ¨**: æ”¯æŒä¸åŒè®­ç»ƒæ¨¡å¼å’Œæ¨¡å‹å¤§å°çš„JSONé…ç½®

## å¼€å‘çŠ¶æ€

é¡¹ç›®å½“å‰ä¸º**ç”Ÿäº§å°±ç»ª**çŠ¶æ€ï¼Œå…·å¤‡ä»¥ä¸‹ç‰¹æ€§ï¼š

### âœ… å®Œæ•´åŠŸèƒ½
- å®Œæ•´çš„ç›‘ç£è®­ç»ƒæµç¨‹
- å¤šé…ç½®æ”¯æŒï¼ˆä¸»è¦/ä¼ ç»Ÿ/å¿«é€Ÿæµ‹è¯•ï¼‰
- å®Œæ•´çš„æ•°æ®å¤„ç†ç®¡é“
- æ™ºèƒ½å…³é”®å¸§é€‰æ‹©å’Œæ¨¡æ€èåˆ
- åˆ†å¸ƒå¼è®­ç»ƒæ”¯æŒ
- è¯¦ç»†çš„æ–‡æ¡£å’Œä½¿ç”¨æŒ‡å—

### ğŸ”§ å¼€å‘å·¥å…·
- äº¤äº’å¼ç¯å¢ƒéªŒè¯ (`quick_start.sh`)
- è‡ªåŠ¨åŒ–è®­ç»ƒå¯åŠ¨ (`start_training.sh`)
- æ ¸å¿ƒç»„ä»¶é›†æˆæµ‹è¯• (`test_medclip.py`)
- è°ƒè¯•å’Œæ€§èƒ½ä¼˜åŒ–æŒ‡å—

### ğŸ“š æ–‡æ¡£ä½“ç³»
- **CLAUDE.md**: å¼€å‘è€…æŠ€æœ¯æŒ‡å—
- **README.md**: ç”¨æˆ·ä½¿ç”¨æ‰‹å†Œ
- **UME_PRD/**: è¯¦ç»†äº§å“éœ€æ±‚æ–‡æ¡£
- **æŠ€æœ¯æŠ¥å‘Š**: é¡¹ç›®å®ŒæˆæŠ¥å‘Šå’Œä»£ç ç»Ÿè®¡

## è‡´è°¢

æœ¬é¡¹ç›®æ•´åˆäº†å¤šç§å…ˆè¿›çš„åŒ»å­¦å½±åƒå¤„ç†æŠ€æœ¯ï¼Œç‰¹åˆ«æ„Ÿè°¢MONAIç¤¾åŒºå’Œç›¸å…³ç ”ç©¶å·¥ä½œçš„è´¡çŒ®ã€‚**è‡ªé€‚åº”å¤šæ¨¡æ€åŠ¨æ€é‡‡æ ·ç¼–ç å™¨æ˜¯æœ¬é¡¹ç›®çš„æ ¸å¿ƒåˆ›æ–°**ï¼Œä¸ºåŒ»å­¦å½±åƒçš„æ™ºèƒ½å…³é”®å¸§é€‰æ‹©å’Œå¤šæ¨¡æ€èåˆæä¾›äº†æ–°çš„è§£å†³æ–¹æ¡ˆï¼Œèƒ½å¤Ÿé«˜æ•ˆå¤„ç†ä»»æ„æ•°é‡çš„æ¨¡æ€å¹¶æ™ºèƒ½é€‰æ‹©æœ€ç›¸å…³çš„å¸§ã€‚